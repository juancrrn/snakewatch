<!DOCTYPE html>
<html class="h-100" xmlns:th="http://www.thymeleaf.org">

<head>
    <th:block th:replace="fragments/head :: header" />
    <title>Perfil — Snakewatch</title>
</head>

<body class="d-flex flex-column h-100">
    <header th:replace="fragments/nav.html :: nav"></header>

    <main class="flex-shrink-0">
        <div class="container">

            <span style="display: inline-block; width: 40px; height: 50px;"></span>
      
            <div>
              <h1 class="col" style="text-align:center"
                th:text="| ${user.username} &nbsp;&nbsp;&nbsp; ${friendships.size()} amigos &nbsp;&nbsp;&nbsp; ${matchPlayers.size()} partidas|">
              </h1>
            </div>
      
            <span style="display: inline-block; width: 40px; height: 30px;"></span>
      
            <table class="table table-light">
              <thead>
                <tr>
                  <th>Partida</th>
                  <th>Sala</th>
                  <th>Resultado</th>
                  <th>Participantes</th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="matchPlayer: ${matchPlayers}">
                  <td th:text="| # ${matchPlayer.match.id} |"></td>
                  <td th:text="| ${matchPlayer.match.room.id} |"></td>
                  <td th:text="| ${matchPlayer.position} º|"></td>
                  <td th:each="matchPlayerOthers: ${matchPlayer.match.getMatchPlayers()}">
                    <a th:href="@{/user/__${matchPlayerOthers.player.id}__}" th:text="| ${matchPlayerOthers.player.username} |"></a>
                  </td>
                </tr>
              </tbody>
            </table>
      
            <span style="display: inline-block; width: 40px; height: 50px;"></span>
      
            <table th:if="${isLoggedUser}" class="table table-light">
              <thead>
                <tr rowspan="1">
                  <th colspan="1">Friend Request Id</th>
                  <th colspan="1">Sender Id</th>
                  <th colspan="1">Sender Username</th>
                  <th colspan="1">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr rowspan="1" th:each="request: ${friendRequests}">
                  <td colspan="1" th:text="${request.id}">ID</td>
                  <td colspan="1" th:text="${request.user1.id}">Nombre</td>
                  <td colspan="1"> 
                    <a th:href="@{/user/__${request.user1.id}__}" th:text="| ${request.user1.username} |"></a>
                  </td>
                  <td colspan="1">
                    <form th:action="@{/user/accept_friend_req/__${request.id}__}" method="POST">
                      <button id="accept_friend_req" class="btn btn-secondary" type="submit">Aceptar</button>
                    </form>
                  </td>
                </tr>
              </tbody>
            </table>
      
            <span style="display: inline-block; width: 40px; height: 50px;"></span>
      
            <table th:if="${isLoggedUser}" class="table table-light">
              <thead>
                <tr rowspan="1">
                  <th colspan="1">Friend Id</th>
                  <th colspan="1">Friend Username</th>
                </tr>
              </thead>
              <tbody>
                <tr rowspan="1" th:each="friendship: ${friendships}">
                  <td colspan="1" th:text="${friendship.user2.id}">ID</td>
                  <td colspan="1">
                    <a th:href="@{/user/__${friendship.user2.id}__}" th:text="| ${friendship.user2.username} |"></a>
                  </td>
                </tr>
              </tbody>
            </table>
      
            <span style="display: inline-block; width: 40px; height: 50px;"></span>
      
            <table class="table table-light">
              <thead>
                <tr rowspan="1">
                  <th colspan="1">Room Id</th>
                  <th colspan="1">Room Privacy</th>
                  <th colspan="1">Room Users</th>
                </tr>
              </thead>
              <tbody>
                <tr rowspan="1" th:each="roomUser: ${roomUsers}">
                  <td colspan="1" th:text="${roomUser.room.id}">ID</td>
                  <td colspan="1" th:text="${roomUser.room.visibility}">Privacy</td>

                  <td th:each="participant: ${roomUser.room.getRoomUsers()}">
                    <a th:href="@{/user/__${participant.user.id}__}" th:text="| ${participant.user.username} |"></a>
                  </td>
                </tr>
              </tbody>
            </table>

            <!-- para enviar mensajes; algo feo -->
            <div class="d-flex justify-content-around">
              <form th:if="${not isFriends and not hasPendingRequest and not isLoggedUser}" th:action="@{/user/__${user.id}__/send_friend_req}" method="POST">
                <button id="send_friend_req" class="btn btn-secondary" type="submit">Solicitar amistad</button>
              </form>

              <p th:if="${hasPendingRequest}" class="text-light bg-secondary" >¡Solicitud Enviada!</p>

              <p th:if="${isFriends}" class="text-light bg-secondary" >¡Ya sois amigos!</p>

              <form th:if="${not isLoggedUser}" th:action="@{/user/__${user.id}__/msg}" method="POST">
                  <input type="text" id="message" placeholder="escribe a este usuario" />
                  <button id="sendmsg" class="btn btn-secondary" type="submit">Enviar</button>
              </form>
            </div>

      
      
          </div>
        
    </main>

    <th:block th:replace="fragments/footer.html :: footer" />
    <script>
        // envio de mensajes con AJAX
        let b = document.getElementById("sendmsg");
        b.onclick = (e) => {
            e.preventDefault();
            go(b.parentNode.action, 'POST', {
                    message: document.getElementById("message").value
                })
                .then(d => console.log("happy", d))
                .catch(e => console.log("sad", e))
        }
    </script>
</body>

</html>